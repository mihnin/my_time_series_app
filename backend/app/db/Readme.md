## Конфигурация

Модуль ожидает наличия файла `settings.py` (или аналогичного механизма), содержащего следующие константы:

* `DB_NAME`: Имя базы данных.
* `DB_HOST`: Хост базы данных.
* `DB_PORT`: Порт базы данных.
* `SCHEMA`: Имя схемы по умолчанию для работы.
* `MODULE_READ_ONLY`: Булево значение (`True` или `False`), включающее или выключающее режим "только для чтения".

## Справочник API

---

### `get_connection(username: str, password: str)`

* **Назначение**: Устанавливает асинхронное соединение с базой данных PostgreSQL.
* **Описание**: Является асинхронным контекстным менеджером, который обеспечивает получение объекта соединения `asyncpg.Connection` с использованием указанных имени пользователя и пароля, а также настроек из `settings`. Гарантирует автоматическое закрытие соединения после завершения работы с ним.
---

### `read_only_guard(func)`

* **Назначение**: Обеспечивает режим "только для чтения".
* **Описание**: Декоратор, который проверяет значение `settings.MODULE_READ_ONLY`. Если установлено значение `True`, выполнение декорируемой функции прерывается, и выбрасывается исключение `PermissionError`. Используется для защиты функций, изменяющих данные.

---

### `fetch_table_as_dataframe(table_name: str, username: str, password: str) -> pd.DataFrame`

* **Назначение**: Извлечение данных из таблицы в pandas DataFrame.
* **Описание**: Выполняет запрос `SELECT *` к указанной таблице в схеме `settings.SCHEMA`. Проверяет существование таблицы перед извлечением. Возвращает данные в виде объекта `pandas.DataFrame`.

---

### `create_table_from_df(df: pd.DataFrame, schema: str, table_name: str, username: str, password: str, primary_keys: list = None) -> None`

* **Назначение**: Создание новой таблицы в базе данных на основе структуры DataFrame.
* **Описание**: Генерирует и выполняет SQL-запрос `CREATE TABLE`. Типы данных PostgreSQL определяются на основе типов pandas DataFrame (все числовые преобразуются в `DOUBLE PRECISION`). Позволяет указать первичный ключ. Вызывает исключение, если таблица уже существует.
* **Примечание**: *Данная функция защищена декоратором `read_only_guard`*.

---

### `upload_df_to_db(df: pd.DataFrame, schema: str, table_name: str, username: str, password: str, update_on_pk: bool = True) -> bool`

* **Назначение**: Загрузка данных из DataFrame в существующую таблицу.
* **Описание**: Осуществляет пакетную вставку данных. Если `update_on_pk=True`, пытается выполнить "upsert" (INSERT ON CONFLICT), обновляя записи при конфликте по первичному ключу. Требует наличия первичного ключа в таблице и соответствующих столбцов в DataFrame для режима "upsert".
* **Примечание**: *Данная функция защищена декоратором `read_only_guard`*.

---

### `get_table_rows(schema: str, table_name: str, username: str, password: str, limit: int | None = None) -> list[dict]`

* **Назначение**: Получение строк из таблицы для предварительного просмотра.
* **Описание**: Выполняет `SELECT *` из указанной таблицы с опциональным ограничением количества строк (`LIMIT`). Возвращает результат в виде списка словарей.

---

### `upload_dicts_to_db(records: list[dict], schema: str, table_name: str, username: str, password: str, update_on_pk: bool = True) -> bool`

* **Назначение**: Загрузка данных из списка словарей в существующую таблицу.
* **Описание**: Осуществляет пакетную вставку данных. Если `update_on_pk=True`, выполняет UPSERT (INSERT ON CONFLICT), обновляя записи при конфликте по первичному ключу. Требует, чтобы все словари имели одинаковые ключи, соответствующие столбцам таблицы. Таблица должна быть создана заранее.
* **Примечание**: *Данная функция защищена декоратором `read_only_guard`*.

---

### `get_user_table_names(username: str, password: str) -> List[str]`

* **Назначение**: Получение списка таблиц, доступных пользователю в схеме по умолчанию.
* **Описание**: Возвращает список имен таблиц в схеме `settings.SCHEMA`, для которых текущий пользователь имеет привилегию `SELECT`.

---

### `get_user_table_names_by_schema(username: str, password: str) -> dict`

* **Назначение**: Получение списка таблиц, доступных пользователю, сгруппированных по схемам.
* **Описание**: Возвращает словарь, где ключи - это имена схем, а значения - списки имен таблиц в этих схемах, к которым у пользователя есть право `SELECT`.

---

### `check_db_connection(username: str, password: str) -> bool`

* **Назначение**: Проверка возможности подключения к базе данных.
* **Описание**: Пытается установить соединение с базой данных. Возвращает `True` при успехе, `False` при неудаче.

---

### `check_df_matches_table_schema(df: pd.DataFrame, schema: str, table_name: str, username: str, password: str) -> bool`

* **Назначение**: Проверка соответствия структуры DataFrame схеме таблицы в БД.
* **Описание**: Сравнивает столбцы и типы данных DataFrame со схемой таблицы в базе данных. Возвращает `True`, если структура DataFrame совместима со структурой таблицы (все столбцы DF есть в таблице и типы совместимы), иначе `False`.

---

### `get_total_table_count(username: str, password: str) -> int`

* **Назначение**: Получение общего количества таблиц в схеме по умолчанию.
* **Описание**: Возвращает количество таблиц в схеме `settings.SCHEMA`.

---

### `get_total_table_count_by_schema(username: str, password: str) -> dict`

* **Назначение**: Получение количества таблиц в каждой схеме.
* **Описание**: Возвращает словарь, где ключи - имена схем, а значения - количество таблиц в них.

---

### Вспомогательные элементы

* **`DTYPE_MAP`**: Словарь для сопоставления типов pandas с типами PostgreSQL при создании таблиц.
* **`PG_TO_PD_TYPE_MAP`**: Словарь для сопоставления типов PostgreSQL с типами pandas при проверке схем.
* **`_get_pk_columns(...)`**: Внутренняя функция для получения имен столбцов первичного ключа.